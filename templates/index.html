<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirGuard Pro Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.4/dist/cal-heatmap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.4/dist/plugins/Tooltip.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.4/dist/cal-heatmap.css">

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .ch-domain-text { fill: #6b7280 !important; font-size: 12px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 pb-10 min-h-screen">

    <header class="bg-white shadow-sm sticky top-0 z-20">
        <div class="max-w-5xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-2 rounded-lg text-white">
                    <i data-lucide="wind"></i>
                </div>
                <h1 class="text-xl font-bold text-gray-800 hidden sm:block">AirGuard Pro</h1>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="relative">
                    <select id="city-select" onchange="changeCity()" class="appearance-none bg-gray-100 border border-gray-200 text-gray-700 py-2 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-blue-500 font-medium text-sm">
                        <option value="ho-chi-minh-city">Hồ Chí Minh</option>
                        <option value="hanoi">Hà Nội</option>
                        <option value="can-tho">Cần Thơ</option>
                        <option value="nha-trang">Nha Trang</option>
                        <option value="hue">Huế</option>
                        <option value="vinh">Vinh</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <i data-lucide="chevron-down" class="w-4 h-4"></i>
                    </div>
                </div>

                <div class="hidden sm:flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full">
                    <i data-lucide="map-pin" class="text-gray-500 w-4 h-4"></i>
                    <span class="font-medium text-sm" id="location-text">Loading...</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 mt-6 space-y-6">
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2 bg-white rounded-2xl shadow-sm p-6 flex flex-col sm:flex-row items-center justify-between relative overflow-hidden">
                <div id="aqi-bar" class="absolute top-0 left-0 w-2 h-full bg-gray-200"></div>
                <div class="z-10 text-center sm:text-left w-full sm:w-auto">
                    <h2 class="text-gray-500 font-medium mb-1">Chất lượng không khí hiện tại</h2>
                    <div class="text-5xl font-bold mb-2" id="current-aqi">--</div>
                    <div id="current-status-badge" class="inline-block px-3 py-1 rounded-full text-sm font-bold mb-4 bg-gray-200">--</div>
                    <p class="text-sm text-gray-400">Cập nhật: <span id="update-time">--</span></p>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mt-6 sm:mt-0 z-10 w-full sm:w-auto">
                    <div class="bg-gray-50 p-3 rounded-xl flex items-center gap-3">
                        <i data-lucide="wind" class="text-orange-500"></i>
                        <div class="flex flex-col gap-1">
                            <div class="text-xs text-gray-500">Tốc độ gió</div>
                            <div class="font-bold text-sm"><span id="windspeed">--</span></div>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-xl flex items-center gap-3">
                        <i data-lucide="cloud-rain" class="text-blue-500"></i>
                        <div class="flex flex-col gap-1">
                            <div class="text-xs text-gray-500">Độ ẩm</div>
                            <div class="font-bold text-sm"><span id="humidity">--</span></div>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-xl flex items-center gap-3 col-span-2 sm:col-span-1">
                        <i data-lucide="sun" class="text-yellow-500"></i>
                        <div>
                            <div class="text-xs text-gray-500">Thời tiết</div>
                            <div class="font-bold" id="weather-desc">--</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-blue-50 border border-blue-100 rounded-2xl p-6 flex flex-col justify-center">
                <h3 class="flex items-center gap-2 font-bold text-blue-800 mb-3">
                    <i data-lucide="info" class="w-4 h-4"></i> Khuyến nghị
                </h3>
                <p class="text-sm text-blue-900 leading-relaxed">
                    Theo dõi chỉ số thường xuyên để bảo vệ sức khỏe. Hạn chế ra ngoài khi chỉ số cao.
                </p>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-6">
            <h3 class="font-bold text-lg flex items-center gap-2 mb-6">
                <i data-lucide="clock" class="text-blue-600"></i> Diễn biến 24 giờ tới
            </h3>
            <div class="h-52 w-full relative"><canvas id="hourlyChart"></canvas></div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-6">
            <h3 class="font-bold text-lg flex items-center gap-2 mb-6">
                <i data-lucide="activity" class="text-blue-600"></i> Dự báo 7 ngày tới
            </h3>
            <div class="h-64 w-full relative"><canvas id="weeklyChart"></canvas></div>
            <div id="weekly-cards" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-7 gap-2 mt-6"></div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-6 overflow-x-auto">
            <h3 class="font-bold text-lg flex items-center gap-2 mb-4">
                <i data-lucide="calendar-range" class="text-blue-600"></i> Lịch sử AQI
            </h3>
            <div id="cal-heatmap" class="flex justify-center sm:justify-start"></div>
            <div class="flex justify-end gap-2 items-center mt-4 text-xs text-gray-500">
                <span>Thấp</span>
                <div class="h-2 w-28 bg-gradient-to-r from-green-500 via-yellow-400 to-purple-600 rounded-full"></div>
                <span>Cao</span>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-6 mb-10">
            <h3 class="font-bold text-lg mb-4">Chi tiết chất gây ô nhiễm</h3>
            <div id="pollutants-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </div>
    </main>

    <script>
        const API_URL = "/api/air-quality";
        let hourlyChartInstance = null;
        let weeklyChartInstance = null;
        let cal = null;
        let currentCity = "ho-chi-minh-city"; // Mặc định

        function getAQIColor(aqi) {
            if (aqi <= 50) return { bg: 'bg-green-500', text: 'text-white', hex: '#22c55e', textClass: 'text-green-600' };
            if (aqi <= 100) return { bg: 'bg-yellow-400', text: 'text-black', hex: '#facc15', textClass: 'text-yellow-600' };
            if (aqi <= 150) return { bg: 'bg-orange-500', text: 'text-white', hex: '#f97316', textClass: 'text-orange-600' };
            if (aqi <= 200) return { bg: 'bg-red-500', text: 'text-white', hex: '#ef4444', textClass: 'text-red-600' };
            return { bg: 'bg-purple-600', text: 'text-white', hex: '#9333ea', textClass: 'text-purple-700' };
        }

        // [MODIFIED] Fetch data với tham số city
        async function fetchAirQuality() {
            const res = await fetch(`${API_URL}?city=${currentCity}`);
            if (!res.ok) throw new Error(`Failed: ${res.status}`);
            return res.json();
        }

        // [NEW] Hàm đổi city
        function changeCity() {
            const select = document.getElementById('city-select');
            currentCity = select.value;
            
            // Reset UI Loading
            document.getElementById('location-text').innerText = "Đang tải...";
            document.getElementById('current-aqi').innerText = "--";
            
            renderDashboard();
        }

        function renderCurrent(current) {
            if(!current) return;
            document.getElementById('location-text').innerText = current.location || "Unknown";
            document.getElementById('current-aqi').innerText = current.aqi ?? "--";
            
            const colors = getAQIColor(current.aqi || 0);
            const badge = document.getElementById('current-status-badge');
            badge.innerText = current.status || "--";
            badge.className = `inline-block px-3 py-1 rounded-full text-sm font-bold mb-4 ${colors.bg} ${colors.text}`;
            
            document.getElementById('aqi-bar').className = `absolute top-0 left-0 w-2 h-full ${colors.bg}`;
            document.getElementById('update-time').innerText = current.updated || "--";
            document.getElementById('windspeed').innerText = current.windspeed ?? "--";
            document.getElementById('humidity').innerText = current.humidity ?? "--";

            // [MODIFIED] Hiển thị trực tiếp weather tiếng Việt từ Backend
            document.getElementById('weather-desc').innerText = current.weather || "Không xác định";

            const pollGrid = document.getElementById('pollutants-grid');
            if(Object.keys(current.pollutants || {}).length === 0) {
                 pollGrid.innerHTML = '<div class="col-span-4 text-center text-gray-400 text-sm">Chưa có dữ liệu chi tiết</div>';
            } else {
                pollGrid.innerHTML = Object.entries(current.pollutants || {}).map(([k, v]) => `
                    <div class="p-4 rounded-xl bg-gray-50 border border-gray-100">
                        <div class="flex justify-between items-start mb-2">
                            <span class="uppercase text-xs font-bold text-gray-500">${k}</span>
                            <span class="w-2 h-2 rounded-full ${v > 50 ? 'bg-yellow-400' : 'bg-green-400'}"></span>
                        </div>
                        <div class="text-xl font-bold text-gray-800">${v} <span class="text-xs font-normal text-gray-400">µg/m³</span></div>
                    </div>`).join('');
            }
        }

        function renderWeeklyCards(weekly) {
            const grid = document.getElementById('weekly-cards');
            if (!weekly?.length) return grid.innerHTML = '<div class="col-span-full text-center text-sm text-gray-400">Đang cập nhật dự báo...</div>';
            grid.innerHTML = weekly.map(d => {
                const c = getAQIColor(d.aqi || 0);
                const date = new Date(d.date).toLocaleDateString('vi-VN', {weekday: 'short'});
                return `<div class="flex flex-col items-center p-3 rounded-xl border border-gray-100 bg-gray-50">
                    <span class="text-gray-500 text-sm font-medium mb-1">${date}</span>
                    <span class="text-lg font-bold ${c.textClass}">${d.aqi}</span>
                    <span class="text-xs text-gray-400 mt-1">${d.date}</span>
                </div>`;
            }).join('');
        }

        function renderHeatmap(daily) {
            const container = document.getElementById('cal-heatmap');
            if (typeof CalHeatmap === "undefined") {
                container.innerHTML = "<div class='text-sm text-red-500'>Lỗi thư viện Cal-Heatmap.</div>";
                return;
            }
            if (!daily?.length) {
                container.innerHTML = "<div class='text-sm text-gray-400'>Chưa có dữ liệu lịch sử</div>";
                return;
            }

            const series = daily.map(i => ({
                date: new Date(i.date || i.timestamp || i.day),
                value: i.avg_aqi ?? i.aqi ?? 0
            })).filter(i => !Number.isNaN(i.date.getTime()));

            if (!series.length) return;

            const minDate = new Date(Math.min(...series.map(i => i.date.getTime())));
            const maxDate = new Date(Math.max(...series.map(i => i.date.getTime())));
            const monthDiff = (maxDate.getFullYear() - minDate.getFullYear()) * 12 + (maxDate.getMonth() - minDate.getMonth());
            const rangeMonths = Math.max(1, monthDiff + 1);

            if (cal) cal.destroy();
            cal = new CalHeatmap();

            cal.paint({
                itemSelector: '#cal-heatmap',
                range: rangeMonths,
                domain: { type: 'month', label: { position: 'top' } },
                subDomain: { type: 'day', radius: 2, width: 14, height: 14, gutter: 3 },
                date: { start: new Date(minDate.getFullYear(), 1, 1) }, 
                data: { source: series, x: 'date', y: 'value' },
                scale: {
                    color: {
                        type: 'threshold',
                        domain: [50, 100, 150, 200],
                        range: ['#22c55e', '#facc15', '#f97316', '#ef4444', '#9333ea']
                    }
                },
                theme: 'light'
            });
        }

        function initHourlyChart(hourly) {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            if (hourlyChartInstance) hourlyChartInstance.destroy();
            if (!hourly?.length) return;

            hourlyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hourly.map(d => d.time || new Date(d.timestamp).getHours() + ":00"),
                    datasets: [{
                        data: hourly.map(d => d.aqi),
                        backgroundColor: hourly.map(d => getAQIColor(d.aqi).hex),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false } }, y: { grid: { display: false } } }
                }
            });
        }

        function initWeeklyChart(weekly) {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            if (weeklyChartInstance) weeklyChartInstance.destroy();
            if (!weekly?.length) return;

            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(239, 68, 68, 0.5)');
            gradient.addColorStop(1, 'rgba(239, 68, 68, 0)');

            weeklyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weekly.map(d => new Date(d.date).toLocaleDateString('vi-VN', {weekday: 'short'})),
                    datasets: [{
                        data: weekly.map(d => d.aqi),
                        borderColor: '#ef4444', backgroundColor: gradient, fill: true, tension: 0.4,
                        pointBackgroundColor: '#fff', pointBorderColor: '#ef4444'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false } }, y: { borderDash: [4, 4], beginAtZero: true } }
                }
            });
        }

        async function renderDashboard() {
            try {
                const data = await fetchAirQuality();
                
                if (data?.status === "loading") {
                    document.getElementById('location-text').innerText = "Đang tải dữ liệu...";
                    return;
                }
                
                if (data?.status === "error") {
                    alert("Không tìm thấy dữ liệu cho thành phố này.");
                    return;
                }

                renderCurrent(data.current);
                renderWeeklyCards(data.forecast_7d);
                initHourlyChart(data.forecast_24h);
                initWeeklyChart(data.forecast_7d);
                renderHeatmap(data.heatmap_daily);
                lucide.createIcons();
            } catch (e) { console.error(e); }
        }

        window.onload = renderDashboard;
    </script>
</body>
</html>